document.addEventListener('DOMContentLoaded', () => {
  const textInput = document.getElementById('textInput');
  const cardFormat = document.getElementById('cardFormat');
  const generateBtn = document.getElementById('generateBtn');
  const copyBtn = document.getElementById('copyBtn');
  const clearBtn = document.getElementById('clearBtn');
  const charCount = document.getElementById('charCount');
  const statusDiv = document.getElementById('status');

  // Load saved data
  chrome.storage.local.get(['pdfText', 'cardFormat'], (result) => {
    if (result.pdfText) {
      textInput.value = result.pdfText;
      updateCharCount();
    }
    if (result.cardFormat) {
      cardFormat.value = result.cardFormat;
    }
  });

  textInput.addEventListener('input', () => {
    updateCharCount();
    chrome.storage.local.set({ pdfText: textInput.value });
  });

  cardFormat.addEventListener('change', () => {
    chrome.storage.local.set({ cardFormat: cardFormat.value });
  });

  function updateCharCount() {
    const count = textInput.value.length;
    charCount.textContent = `${count.toLocaleString()} characters`;
  }

  function updateStatus(icon, text, type = 'info') {
    statusDiv.className = `status status-${type}`;
    statusDiv.innerHTML = `
      <div class="status-icon">${icon}</div>
      <div class="status-text">${text}</div>
    `;
  }

  // Copy prompt only
  copyBtn.addEventListener('click', () => {
    const text = textInput.value.trim();
    if (!text) {
      updateStatus('⚠️', 'Please enter some text first', 'warning');
      return;
    }

    const prompt = generatePrompt(text, cardFormat.value);
    navigator.clipboard.writeText(prompt).then(() => {
      updateStatus('✅', 'Prompt copied! Open ChatGPT and paste it', 'success');
    });
  });

  // Generate in ChatGPT
  generateBtn.addEventListener('click', async () => {
    const text = textInput.value.trim();
    
    if (!text) {
      updateStatus('⚠️', 'Please enter some text first', 'warning');
      return;
    }

    const format = cardFormat.value;
    const prompt = generatePrompt(text, format);
    
    await chrome.storage.local.set({ 
      promptToSend: prompt,
      pendingGeneration: true
    });

    updateStatus('✨', 'Opening ChatGPT...', 'info');

    chrome.tabs.create({ 
      url: 'https://chatgpt.com',
      active: true
    }, (tab) => {
      setTimeout(() => {
        chrome.tabs.sendMessage(tab.id, {
          action: 'fillPrompt',
          prompt: prompt
        }, (response) => {
          if (chrome.runtime.lastError) {
            console.log('Tab not ready, will inject on load');
          }
        });
      }, 2500);
    });
  });

  clearBtn.addEventListener('click', () => {
    textInput.value = '';
    updateCharCount();
    chrome.storage.local.remove(['pdfText', 'promptToSend', 'pendingGeneration']);
    updateStatus('ℹ️', 'Cleared! Ready for new text', 'info');
  });

  function generatePrompt(text, format) {
    const formatInstructions = format === 'cloze' 
      ? 'Créez des cartes à trous en utilisant le format {{c1::texte}} pour les termes clés. / Create cloze deletion cards using {{c1::text}} format for key terms.'
      : 'Créez des cartes question-réponse avec des questions claires et spécifiques. / Create question-answer flashcards with clear, specific questions.';

    return `I need you to create Anki flashcards from my study notes.

CRITICAL: Return your response as JSON wrapped in a code block like this:
\`\`\`json
{
  "cards": [...]
}
\`\`\`

FORMAT: ${format === 'cloze' ? 'Cloze Deletion / Texte à trous' : 'Basic Question-Answer / Question-Réponse'}
${formatInstructions}

QUALITY REQUIREMENTS / EXIGENCES DE QUALITÉ:
- Test understanding, not memorization / Testez la compréhension, pas la mémorisation
- One concept per card / Un concept par carte
- Clear and unambiguous / Clair et sans ambiguïté
- Include difficulty level (easy/medium/hard) / Incluez le niveau de difficulté (facile/moyen/difficile)
- Add relevant tags for organization / Ajoutez des étiquettes pertinentes pour l'organisation
- IMPORTANT: Keep the same language as the source material (French or English) / Gardez la même langue que le matériel source (français ou anglais)

EXAMPLES FOR FRENCH CONTENT / EXEMPLES POUR LE CONTENU FRANÇAIS:
${format === 'cloze' ? `
- "L'hypermétropie moyenne du nouveau-né est de {{c1::+2.00 dioptries}}."
- "Le phénomène d'emmétropisation se produit de la naissance jusqu'à {{c1::7-8 ans}}."
- "La myopie congénitale élevée a tendance à {{c1::rester stable}}."
` : `
- "Quelle est l'hypermétropie moyenne du nouveau-né?"
- "À quel âge se termine le phénomène d'emmétropisation?"
- "Comment évolue la myopie congénitale élevée?"
`}

EXAMPLES FOR ENGLISH CONTENT / EXEMPLES POUR LE CONTENU ANGLAIS:
${format === 'cloze' ? `
- "Myopia occurs when light focuses {{c1::in front of}} the retina."
- "The emmetropization process continues until {{c1::7-8 years}} of age."
- "High congenital myopia tends to {{c1::remain stable}}."
` : `
- "What causes distant objects to appear blurry in myopia?"
- "At what age does the emmetropization process complete?"
- "How does high congenital myopia typically progress?"
`}

OUTPUT FORMAT - Return as a JSON code block:
\`\`\`json
{
  "cards": [
    {
      "front": "${format === 'cloze' ? 'Statement with {{c1::hidden text}} / Énoncé avec {{c1::texte caché}}' : 'Clear question / Question claire'}",
      "back": "${format === 'cloze' ? 'The hidden answer / La réponse cachée' : 'Detailed answer with context / Réponse détaillée avec contexte'}",
      "tags": ["topic1", "topic2"],
      "difficulty": "medium"
    }
  ],
  "concepts": ["concept1", "concept2"],
  "medicalTerms": ["term1", "term2"],
  "summary": "Brief overview of content / Aperçu du contenu"
}
\`\`\`

MY STUDY NOTES / MES NOTES D'ÉTUDE:
${text.substring(0, 4000)}

Generate 15-20 high-quality flashcards. Return ONLY the JSON code block above, no other text before or after.
Générez 15-20 cartes de haute qualité. Retournez UNIQUEMENT le bloc JSON ci-dessus, pas d'autre texte avant ou après.`;
  }
});